Here are the comprehensive test cases for the provided Node.js Controller code, covering Success, Error, Validation, and Edge cases for each function.

---

### **1. `getAllStocks` Function Test Cases**

- **Purpose**: Retrieve all stock entries, populating associated food and category information.

| ID      | Description                                                 | Pre-condition                                                                 | Expected Result                                                                                                                                              |
| :------ | :---------------------------------------------------------- | :---------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-GAS-001 | Successfully retrieve all stocks with full food and category info. | Database contains multiple `Stock` entries, each linked to an existing `Food` entry, which is linked to an existing `Category` entry. | Returns `200 OK` with `success: true` and an array of `stocks`, where each stock object contains `_id`, `quantity`, `updatedAt`, `foodInfo` (populated with name, desc, price, image), and `categoryInfo` (populated with category name). |
| TC-GAS-002 | Retrieve stocks when database is empty.                     | Database contains no `Stock` entries.                                         | Returns `200 OK` with `success: true` and an empty array for `stocks`.                                                                                      |
| TC-GAS-003 | Retrieve stocks where a `Stock` exists but its `foodId` is invalid/dangling (not found in Food collection). | Database contains a `Stock` entry with a `foodId` that does not exist in the `Food` collection. | Returns `200 OK` with `success: true` and an array of `stocks`. The entry for the problematic stock should have `foodInfo` as `null` or `undefined`. |
| TC-GAS-004 | Retrieve stocks where `foodId` exists but its `categoryId` is invalid/dangling (not found in Category collection). | Database contains `Stock` and `Food` entries where `food.categoryId` does not exist in the `Category` collection. | Returns `200 OK` with `success: true` and an array of `stocks`. The `categoryInfo` for the problematic food should be `null` or `undefined`.              |
| TC-GAS-005 | Simulate a database query error during `Stock.find()`.    | Mock `Stock.find()` to throw an error.                                        | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-GAS-006 | Simulate a database query error during `populate()`.      | Mock the `populate` chain to throw an error after `Stock.find()`.             | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |

---

### **2. `createStock` Function Test Cases**

- **Purpose**: Create a new stock for a food item or update the quantity of an existing stock.

| ID      | Description                                                 | Pre-condition                                                                 | Expected Result                                                                                                                                              |
| :------ | :---------------------------------------------------------- | :---------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-CS-001 | Successfully create a new stock for an existing food.       | Database contains an existing `Food` entry with `foodId`. No `Stock` entry exists for this `foodId`. Request body includes `foodId` and `quantity` (positive number). | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the newly created `stock` object.                                                     |
| TC-CS-002 | Successfully update quantity of an existing stock.          | Database contains an existing `Food` entry with `foodId` and an existing `Stock` entry for this `foodId`. Request body includes `foodId` and `quantity` (positive number). | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the updated `stock` object with the new total `quantity`.                             |
| TC-CS-003 | Create a new stock with `quantity` as 0.                    | Database contains an existing `Food` entry with `foodId`. No `Stock` entry exists for this `foodId`. Request body includes `foodId` and `quantity: 0`. | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the new `stock` object with `quantity: 0`.                                           |
| TC-CS-004 | Update an existing stock with `quantity` as 0.              | Database contains an existing `Food` entry with `foodId` and an existing `Stock` entry for this `foodId`. Request body includes `foodId` and `quantity: 0`. | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the updated `stock` object with `quantity` unchanged from its original value.        |
| TC-CS-005 | Create a new stock when `quantity` is missing in request.   | Database contains an existing `Food` entry with `foodId`. No `Stock` entry exists for this `foodId`. Request body includes `foodId` but `quantity` is missing. | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the new `stock` object with `quantity: 0` (defaulted).                                |
| TC-CS-006 | Update an existing stock when `quantity` is missing in request. | Database contains an existing `Food` entry with `foodId` and an existing `Stock` entry for this `foodId`. Request body includes `foodId` but `quantity` is missing. | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the updated `stock` object with `quantity` unchanged from its original value.        |
| TC-CS-007 | Attempt to create/update stock with a non-existent `foodId`. | Request body includes a `foodId` that does not exist in the `Food` collection. | Returns `400 Bad Request` with `success: false` and a "Food không tồn tại, hãy Thêm cây mới trước" message.                                              |
| TC-CS-008 | Attempt to create/update stock with an invalid `foodId` format. | Request body includes `foodId` with an invalid ObjectId format (e.g., "invalid_id"). | Returns `400 Bad Request` with `success: false` and a "Food không tồn tại, hãy Thêm cây mới trước" message (as `findById` will return null).          |
| TC-CS-009 | Attempt to create/update stock with `quantity` as a non-numeric string. | Valid `foodId` exists. Request body includes `quantity` as a non-numeric string (e.g., "abc"). | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the stock object (new or updated) with `quantity` based on `Number("abc") || 0` (i.e., 0 added). |
| TC-CS-010 | Simulate a database error during `Food.findById()`.       | Mock `Food.findById()` to throw an error.                                     | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-CS-011 | Simulate a database error during `Stock.findOne()` or `Stock.create()` or `stock.save()`. | Valid `foodId` exists. Mock `Stock` operations (`findOne`, `create`, `save`) to throw an error. | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-CS-012 | Attempt to create a new stock with negative `quantity`.     | Database contains an existing `Food` entry with `foodId`. No `Stock` entry exists for this `foodId`. Request body includes `foodId` and `quantity` (negative number, e.g., -5). | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the newly created `stock` object with the negative `quantity`. (Follows current code logic). |
| TC-CS-013 | Update an existing stock by adding a negative `quantity`.   | Database contains an existing `Food` entry with `foodId` and an existing `Stock` entry for this `foodId`. Request body includes `foodId` and `quantity` (negative number, e.g., -5). | Returns `200 OK` with `success: true`, a "Đã nhập kho" message, and the updated `stock` object with the `quantity` decreased by the negative amount. (Follows current code logic). |

---

### **3. `updateStock` Function Test Cases**

- **Purpose**: Update details of a `Food` item. (Note: The function name is misleading, it operates on `Food`, not `Stock` quantity).

| ID      | Description                                                 | Pre-condition                                                                 | Expected Result                                                                                                                                              |
| :------ | :---------------------------------------------------------- | :---------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-US-001 | Successfully update `Food` details without image or category change. | Database contains an existing `Food` entry with `foodId`. `req.params.foodId` is valid. Request body contains fields to update (e.g., `name`, `description`). | Returns `200 OK` with `success: true` and the updated `food` object, populated with `categoryId.name`.                                                   |
| TC-US-002 | Successfully update `Food` details and upload a new image.  | Database contains an existing `Food` entry with `foodId`. `req.params.foodId` is valid. `req.file` exists (mocked or actual upload). Request body contains fields to update. | Returns `200 OK` with `success: true` and the updated `food` object, where `image` field reflects `req.file.filename`, populated with `categoryId.name`. |
| TC-US-003 | Successfully update `Food` details and change category.     | Database contains an existing `Food` entry with `foodId`. `req.params.foodId` is valid. Request body contains a new, valid `categoryId`. | Returns `200 OK` with `success: true` and the updated `food` object, where `categoryId` is the new one, populated with the new category's name.           |
| TC-US-004 | Successfully update `Food` with empty request body (no changes). | Database contains an existing `Food` entry with `foodId`. `req.params.foodId` is valid. Request body is empty, and `req.file` is null. | Returns `200 OK` with `success: true` and the existing `food` object (unchanged), populated with `categoryId.name`.                                    |
| TC-US-005 | Attempt to update a non-existent `foodId`.                  | `req.params.foodId` is a valid ObjectId format but does not exist in the `Food` collection. | Returns `404 Not Found` with `success: false` and a "Food không tồn tại" message.                                                                           |
| TC-US-006 | Attempt to update with an invalid `foodId` format.          | `req.params.foodId` is an invalid ObjectId format (e.g., "invalid_id").       | Returns `404 Not Found` with `success: false` and a "Food không tồn tại" message (as `findByIdAndUpdate` will return null).                              |
| TC-US-007 | Simulate database error during `Food.findByIdAndUpdate()`. | Valid `foodId` in `req.params`. Mock `Food.findByIdAndUpdate()` to throw an error. | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-US-008 | Attempt to update `Food` with a non-existent `categoryId`.  | Valid `foodId` in `req.params`. Request body contains a `categoryId` that does not exist in the `Category` collection. | Returns `200 OK` with `success: true` and the updated `food` object, where `categoryId` is the non-existent ID. The `populate` for `categoryId` will yield `null` for `name`. (Note: This assumes Mongoose doesn't validate `categoryId` existence at schema level). |

---

### **4. `deleteStock` Function Test Cases**

- **Purpose**: Delete a stock entry and its associated food entry.

| ID      | Description                                                 | Pre-condition                                                                 | Expected Result                                                                                                                                              |
| :------ | :---------------------------------------------------------- | :---------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-DS-001 | Successfully delete an existing stock and its associated food. | Database contains an existing `Stock` entry with `stockId` and its linked `Food` entry. `req.params.stockId` is valid. | Returns `200 OK` with `success: true` and a "Đã xoá Food + Stock" message. Both `Stock` and `Food` entries should be removed from the database.      |
| TC-DS-002 | Attempt to delete a non-existent `stockId`.                 | `req.params.stockId` is a valid ObjectId format but does not exist in the `Stock` collection. | Returns `404 Not Found` with `success: false` and a "Không tìm thấy stock" message.                                                                        |
| TC-DS-003 | Attempt to delete with an invalid `stockId` format.         | `req.params.stockId` is an invalid ObjectId format (e.g., "invalid_id").      | Returns `404 Not Found` with `success: false` and a "Không tìm thấy stock" message (as `findById` will return null).                                      |
| TC-DS-004 | Simulate a database error during `Stock.findById()`.      | Mock `Stock.findById()` to throw an error.                                    | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-DS-005 | Simulate a database error during `Food.findByIdAndDelete()`. | Valid `stockId` exists. Mock `Food.findByIdAndDelete()` to throw an error.    | Returns `500 Internal Server Error` with `success: false` and an error message. The `Stock` entry might remain, and the `Food` entry might remain or be partially deleted depending on the error point. |
| TC-DS-006 | Simulate a database error during `Stock.findByIdAndDelete()`. | Valid `stockId` exists, and `Food.findByIdAndDelete()` succeeds. Mock `Stock.findByIdAndDelete()` to throw an error. | Returns `500 Internal Server Error` with `success: false` and an error message. The `Food` entry should be deleted, but the `Stock` entry will remain (partial deletion). |
| TC-DS-007 | Delete stock where `foodId` in stock is null/invalid (data integrity issue). | Database contains a `Stock` entry where `stock.foodId` is null or refers to a non-existent food. | Returns `200 OK` with `success: true` and a "Đã xoá Food + Stock" message. The `Stock` should be deleted. `Food.findByIdAndDelete(null)` or `(invalid_id)` will likely return null and not throw, allowing the stock to be deleted. |

---

### **5. `changeQuantity` Function Test Cases**

- **Purpose**: Change the quantity of an existing stock item.

| ID      | Description                                                 | Pre-condition                                                                 | Expected Result                                                                                                                                              |
| :------ | :---------------------------------------------------------- | :---------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| TC-CQ-001 | Successfully increase quantity of an existing stock.        | Database contains an existing `Stock` entry with `foodId`. Request body includes `foodId` and a positive `qty`. | Returns `200 OK` with `success: true` and the updated `stock` object, with `quantity` increased by `qty`.                                                |
| TC-CQ-002 | Successfully decrease quantity of an existing stock (positive result). | Database contains an existing `Stock` entry with `foodId` and `quantity > |qty|`. Request body includes `foodId` and a negative `qty`. | Returns `200 OK` with `success: true` and the updated `stock` object, with `quantity` decreased by `|qty|`.                                             |
| TC-CQ-003 | Successfully decrease quantity to exactly zero.             | Database contains an existing `Stock` entry with `foodId` and `quantity = |qty|`. Request body includes `foodId` and a negative `qty`. | Returns `200 OK` with `success: true` and the updated `stock` object, with `quantity: 0`.                                                               |
| TC-CQ-004 | Successfully attempt to decrease quantity below zero (clamped to zero). | Database contains an existing `Stock` entry with `foodId` and `quantity < |qty|`. Request body includes `foodId` and a negative `qty`. | Returns `200 OK` with `success: true` and the updated `stock` object, with `quantity: 0`.                                                               |
| TC-CQ-005 | Change quantity with `qty` as 0.                            | Database contains an existing `Stock` entry with `foodId`. Request body includes `foodId` and `qty: 0`. | Returns `200 OK` with `success: true` and the `stock` object, with `quantity` unchanged.                                                                 |
| TC-CQ-006 | Change quantity when `qty` is missing in request.           | Database contains an existing `Stock` entry with `foodId`. Request body includes `foodId` but `qty` is missing. | Returns `200 OK` with `success: true` and the `stock` object, with `quantity` unchanged (as `Number(undefined) || 0` is `0`).                            |
| TC-CQ-007 | Attempt to change quantity for a non-existent `foodId`.     | Request body includes a `foodId` that does not have a corresponding `Stock` entry. | Returns `404 Not Found` with `success: false` and a "Không tìm thấy stock" message.                                                                        |
| TC-CQ-008 | Attempt to change quantity with an invalid `foodId` format. | Request body includes `foodId` with an invalid ObjectId format (e.g., "invalid_id"). | Returns `404 Not Found` with `success: false` and a "Không tìm thấy stock" message (as `findOne` will return null).                                      |
| TC-CQ-009 | Attempt to change quantity with `qty` as a non-numeric string. | Valid `foodId` exists. Request body includes `qty` as a non-numeric string (e.g., "abc"). | Returns `200 OK` with `success: true` and the `stock` object, with `quantity` unchanged (as `Number("abc") || 0` is `0`).                                |
| TC-CQ-010 | Simulate a database error during `Stock.findOne()`.       | Mock `Stock.findOne()` to throw an error.                                     | Returns `500 Internal Server Error` with `success: false` and an error message.                                                                           |
| TC-CQ-011 | Simulate a database error during `stock.save()`.          | Valid `foodId` exists, `Stock` found. Mock `stock.save()` to throw an error.  | Returns `500 Internal Server Error` with `success: false` and an error message. The `Stock` quantity should not be updated in the database.                |